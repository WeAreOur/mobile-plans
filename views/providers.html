<div class="container">
  <header class="header">
    <h1 id="page-title">Mobile Plans</h1>
    
    <div class="controls">
      <select id="country-select" onchange="updateConfig({ country: this.value })" style="display: none;">
        <option value="uk">United Kingdom</option>
        <option value="us">United States</option>
      </select>
      
      <select id="locale-select" onchange="updateConfig({ locale: this.value })" style="display: none;">
        <option value="en">English</option>
        <option value="ar">العربية</option>
        <option value="he">עברית</option>
      </select>
      
      <select id="view-select" onchange="updateConfig({ view: this.value })">
        <option value="providers">Cards</option>
        <option value="comparison">Table</option>
      </select>
      
      <select id="sort-select" onchange="window.sortPlans(this.value)">
        <option value="price-asc" selected>Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
        <option value="data-asc">Data: Low to High</option>
        <option value="data-desc">Data: High to Low</option>
        <option value="provider-asc">Provider: A to Z</option>
        <option value="provider-desc">Provider: Z to A</option>
      </select>
      
      <select id="filter-price-rise" onchange="window.applyFilters()">
        <option value="all">All Plans</option>
        <option value="no-rises">No Price Rises Only</option>
        <option value="with-rises">With Price Rises</option>
      </select>
      
      <select id="filter-5g" onchange="window.applyFilters()">
        <option value="all">All Networks</option>
        <option value="5g-only">5G Only</option>
      </select>
    </div>
  </header>

  <div id="providers-list" class="providers-grid"></div>
  
  <footer class="footer">
    <p>
      <span id="data-attribution"></span> • 
      <a href="https://github.com/WeAreOur/mobile-plans">Contribute on GitHub</a> • 
      <a href="/legal/LICENSE.md">CC-BY-SA 4.0</a> • 
      <a href="/legal/PRIVACY.md">Privacy</a> • 
      <a href="/legal/TERMS.md">Terms</a> • 
      <a href="/docs/GOVERNANCE.md">Governance</a>
    </p>
  </footer>
</div>

<script>
  let currentSort = 'price-asc';
  let sortedProviders = [];
  let allProviders = [];
  let currentFilters = {
    priceRise: 'all',
    fiveG: 'all'
  };
  
  window.applyFilters = function() {
    currentFilters.priceRise = document.getElementById('filter-price-rise').value;
    currentFilters.fiveG = document.getElementById('filter-5g').value;
    
    sortedProviders = allProviders.filter(plan => {
      // Price rise filter
      if (currentFilters.priceRise === 'no-rises') {
        if (plan.priceIncrease && plan.priceIncrease !== 'None') return false;
      } else if (currentFilters.priceRise === 'with-rises') {
        if (!plan.priceIncrease || plan.priceIncrease === 'None') return false;
      }
      
      // 5G filter
      if (currentFilters.fiveG === '5g-only') {
        if (!plan['5g']) return false;
      }
      
      return true;
    });
    
    window.sortPlans(currentSort);
  };
  
  window.sortPlans = function(sortType) {
    currentSort = sortType;
    const [field, direction] = sortType.split('-');
    
    sortedProviders.sort((a, b) => {
      let aVal, bVal;
      
      switch(field) {
        case 'price':
          aVal = a.price;
          bVal = b.price;
          break;
        case 'data':
          // Convert data to sortable number (GB)
          aVal = parseData(a.data);
          bVal = parseData(b.data);
          break;
        case 'provider':
          aVal = a.provider.name.toLowerCase();
          bVal = b.provider.name.toLowerCase();
          break;
        default:
          return 0;
      }
      
      if (direction === 'asc') {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });
    
    renderProviders();
  };
  
  function parseData(dataStr) {
    if (!dataStr || dataStr === 'N/A') return -1;
    if (dataStr.toLowerCase() === 'unlimited') return 999999;
    const match = dataStr.match(/(\d+(?:\.\d+)?)\s*(GB|MB)/i);
    if (!match) return 0;
    const value = parseFloat(match[1]);
    const unit = match[2].toUpperCase();
    return unit === 'GB' ? value : value / 1024;
  }
  
  function formatRoaming(roaming) {
    if (!roaming || !roaming.euDailyCharge) return 'N/A';
    const charge = roaming.euDailyCharge.toLowerCase();
    if (charge === 'free' || charge === 'none') {
      const limit = roaming.euDataLimit || '';
      // Only show cap if it's a specific value (not Unknown, Unlimited, or empty)
      if (limit && limit.toLowerCase() !== 'unknown' && limit.toLowerCase() !== 'unlimited') {
        return `Free EU (up to ${limit})`;
      }
      return 'Free EU';
    }
    return roaming.euDailyCharge;
  }
  
  function renderProviders() {
    const container = document.getElementById('providers-list');
    container.innerHTML = sortedProviders.map(plan => `
      <div class="card card-${plan.status}">
        <div class="card-header">
          <h3>${plan.provider.name}</h3>
        </div>
        
        <h4 class="plan-name">${plan.name}</h4>
        
        ${plan['5g'] || plan.speedCap || plan.priceIncrease ? `
        <div class="plan-badges">
          ${plan['5g'] ? '<span class="badge badge-5g">5G</span>' : ''}
          ${plan.speedCap && plan.speedCap !== 'Uncapped' ? `<span class="badge badge-speed">${plan.speedCap}</span>` : ''}
          ${plan.priceIncrease && plan.priceIncrease !== 'None' ? `<span class="badge badge-warning">${plan.priceIncrease}</span>` : ''}
          ${!plan.priceIncrease || plan.priceIncrease === 'None' ? '<span class="badge badge-success">No price rises</span>' : ''}
        </div>
        ` : ''}
        
        <div class="plan-details">
          <div class="detail-row">
            <span class="label">${window.t('price')}:</span>
            <span class="value price">${plan.currency} ${plan.price}/mo</span>
          </div>
          <div class="detail-row">
            <span class="label">${window.t('data')}:</span>
            <span class="value">${plan.data}</span>
          </div>
          <div class="detail-row">
            <span class="label">${window.t('minutes')}:</span>
            <span class="value">${plan.minutes || 'N/A'}</span>
          </div>
          <div class="detail-row">
            <span class="label">${window.t('contract')}:</span>
            <span class="value">${plan.contractLength || 'N/A'}</span>
          </div>
          ${plan.network ? `
          <div class="detail-row">
            <span class="label">Network:</span>
            <span class="value">${plan.network}</span>
          </div>
          ` : ''}
          ${plan.roaming ? `
          <div class="detail-row">
            <span class="label">Roaming:</span>
            <span class="value">${formatRoaming(plan.roaming)}</span>
          </div>
          ` : ''}
        </div>
        
        <div class="card-footer">
          <a href="${plan.metadata.sources[0].url}" target="_blank" rel="noopener">
            ${window.t('view_plan')}
          </a>
          <span class="badge badge-review-date">
            Last reviewed: ${plan.metadata.sources[0].accessDate}
          </span>
        </div>
      </div>
    `).join('');
  }
  
  window.initView = function() {
    const { providers, meta } = window.currentData;
    const attribution = document.getElementById('data-attribution');
    
    // Update title
    document.getElementById('page-title').textContent = window.t('title');
    
    // Filter to show only verified and complete plans
    allProviders = providers.filter(plan => 
      plan.status === 'complete' && plan.metadata.confidence === 'verified'
    );
    
    // Apply initial filters
    window.applyFilters();
    
    // Update attribution
    attribution.textContent = `${meta.country} • ${allProviders.length} plans`;
  };
</script>
